#!/bin/bash
set -eux

app=$1
git_hash=$2

# create virtualenv for the app
venv="/opt/$app"
mkdir -p "${venv}"
chown abc:abc "${venv}"
chroot --userspec=abc / HOME=/home/abc python3.6 -m venv "${venv}"
chroot --userspec=abc / HOME=/home/abc "${venv}/bin/pip" install --cache-dir "${PIPCACHE:-}" -U setuptools pip

# install flamegraph for profiling
chroot --userspec=abc / HOME=/home/abc "${venv}/bin/pip" install --cache-dir "${PIPCACHE:-}" git+https://github.com/evanhempel/python-flamegraph.git

# clone the app
git clone "https://github.com/makerdao/${app}.git" "${venv}/src"
cd "${venv}/src"
git reset --hard "$git_hash"
git submodule update --init --recursive
chown -R abc:abc .

# install dependencies
chroot --userspec=abc / HOME=/home/abc "${venv}/bin/pip" install --cache-dir "${PIPCACHE:-}" -r "${venv}/src/requirements.txt"
